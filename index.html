<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>tBNB Faucet – 0.3 tBNB</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 0;
      background: #020617;
      color: #e5e7eb;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .card {
      background: #0f172a;
      padding: 1.75rem;
      border-radius: 1.25rem;
      max-width: 420px;
      width: 100%;
      box-shadow: 0 24px 60px rgba(0,0,0,.6);
    }
    h1 {
      margin: 0 0 .25rem;
      font-size: 1.5rem;
    }
    .subtitle {
      margin: 0 0 1.25rem;
      font-size: .9rem;
      color: #9ca3af;
    }
    label {
      display: block;
      font-size: .85rem;
      margin-bottom: .25rem;
    }
    input {
      width: 100%;
      padding: .6rem .7rem;
      border-radius: .75rem;
      border: 1px solid #374151;
      background: #020617;
      color: #f9fafb;
      font-size: .95rem;
      outline: none;
      margin-bottom: .75rem;
    }
    input:focus {
      border-color: #4f46e5;
      box-shadow: 0 0 0 1px #4f46e5;
    }
    button {
      width: 100%;
      padding: .7rem 1rem;
      border-radius: 999px;
      border: none;
      font-size: .95rem;
      font-weight: 600;
      cursor: pointer;
      margin-top: .5rem;
      background: #10b981;
      color: white;
      box-shadow: 0 12px 30px rgba(16,185,129,.5);
      transition: transform .05s, box-shadow .05s, opacity .2s;
    }
    button:active {
      transform: translateY(1px);
      box-shadow: none;
    }
    button[disabled] {
      opacity: .5;
      cursor: not-allowed;
      box-shadow: none;
    }
    .hint {
      font-size: .8rem;
      color: #9ca3af;
      margin-top: .75rem;
    }
    .stats {
      margin-top: .75rem;
      background: #020617;
      border: 1px solid #111827;
      border-radius: .75rem;
      padding: .75rem;
    }
    .stats-title {
      margin: 0 0 .5rem;
      font-size: .9rem;
      color: #9ca3af;
    }
    .stats-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: .6rem;
      margin-bottom: .6rem;
    }
    .stat {
      background: #0b1220;
      border: 1px solid #111827;
      border-radius: .6rem;
      padding: .5rem .6rem;
    }
    .stat .label { color: #9ca3af; font-size: .75rem; }
    .stat .value { font-size: 1.05rem; font-weight: 700; }
    .stat .subvalue { color: #9ca3af; font-size: .75rem; margin-top: .2rem; }
    .stats-note { color: #9ca3af; font-size: .75rem; margin: 0; }
    .log {
      margin-top: .75rem;
      font-size: .85rem;
      background: #020617;
      border-radius: .75rem;
      padding: .75rem;
      max-height: 180px;
      overflow: auto;
      border: 1px solid #111827;
    }
    .log-item {
      display: flex;
      gap: .5rem;
      align-items: flex-start;
      padding: .5rem .6rem;
      border-radius: .6rem;
      border: 1px solid #111827;
      background: #0b1220;
      color: #e5e7eb;
      margin-bottom: .5rem;
    }
    .log-item:last-child { margin-bottom: 0; }
    .log-item .icon { font-size: 1rem; line-height: 1.2; }
    .log-item .content { flex: 1; }
    .log-item.info { border-left: 4px solid #4f46e5; }
    .log-item.success { border-left: 4px solid #10b981; }
    .log-item.error { border-left: 4px solid #ef4444; }
    .log-item a { color: #93c5fd; text-decoration: none; }
    .log-item a:hover { text-decoration: underline; }
    code { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; background: #0b1220; padding: 0 .25rem; border-radius: .3rem; }
  </style>
</head>
<body>
  <div class="card">
    <h1>tBNB Faucet</h1>
    <p class="subtitle">Get <b>0.3 tBNB</b> on BSC Testnet (chainId 97)</p>

    <label for="addr">Recipient address</label>
    <input id="addr" placeholder="0x..." autocomplete="off" />

    <button id="btn">Request 0.3 tBNB</button>

    <p class="hint">
      • Network: <b>BNB Smart Chain Testnet</b> (tBNB).<br/>
      • No BNB required by you; faucet pays gas.<br/>
      • Cooldown per address enforced by the contract.
    </p>

    <div class="stats" id="stats">
      <p class="stats-title">Usage</p>
      <div class="stats-row">
        <div class="stat">
          <div class="label">Drips</div>
          <div class="value" id="stat-drips-total">—</div>
          <div class="subvalue">24h: <span id="stat-drips-24h">—</span></div>
        </div>
        <div class="stat">
          <div class="label">Unique recipients</div>
          <div class="value" id="stat-unique-total">—</div>
          <div class="subvalue">24h: <span id="stat-unique-24h">—</span></div>
        </div>
      </div>
      <div class="stats-row">
        <div class="stat">
          <div class="label">Dispensed</div>
          <div class="value" id="stat-amount-total">—</div>
          <div class="subvalue">24h: <span id="stat-amount-24h">—</span></div>
        </div>
        <div class="stat">
          <div class="label">Latest</div>
          <div class="value" id="stat-latest">—</div>
          <div class="subvalue" id="stat-latest-time"> </div>
        </div>
      </div>
      <p class="stats-note" id="stats-note"></p>
    </div>

    <div id="log" class="log" aria-live="polite" aria-atomic="false"></div>
  </div>

<script>
  const btn = document.getElementById("btn");
  const logEl = document.getElementById("log");
  const dripsTotalEl = document.getElementById("stat-drips-total");
  const drips24hEl = document.getElementById("stat-drips-24h");
  const uniqueTotalEl = document.getElementById("stat-unique-total");
  const unique24hEl = document.getElementById("stat-unique-24h");
  const amountTotalEl = document.getElementById("stat-amount-total");
  const amount24hEl = document.getElementById("stat-amount-24h");
  const latestEl = document.getElementById("stat-latest");
  const latestTimeEl = document.getElementById("stat-latest-time");
  const statsNoteEl = document.getElementById("stats-note");

  function shortenAddress(addr) {
    return addr ? addr.slice(0, 6) + "…" + addr.slice(-4) : "";
  }

  function log(msg, type = "info", { html = false, icon } = {}) {
    const wrap = document.createElement("div");
    wrap.className = `log-item ${type}`;

    const iconEl = document.createElement("div");
    iconEl.className = "icon";
    iconEl.textContent = icon || (type === "success" ? "✅" : type === "error" ? "❌" : "⏳");

    const contentEl = document.createElement("div");
    contentEl.className = "content";
    if (html) contentEl.innerHTML = msg; else contentEl.textContent = msg;

    wrap.appendChild(iconEl);
    wrap.appendChild(contentEl);
    logEl.appendChild(wrap);
    logEl.scrollTop = logEl.scrollHeight;
  }

  function isHexAddress(addr) {
    return /^0x[a-fA-F0-9]{40}$/.test(addr);
  }

  async function fetchJSON(url) {
    const res = await fetch(url);
    const text = await res.text();
    let data;
    try { data = JSON.parse(text); } catch { throw new Error(text); }
    if (!res.ok) throw new Error(data.error || text);
    return data;
  }

  function setStatsLoading() {
    dripsTotalEl.textContent = uniqueTotalEl.textContent = amountTotalEl.textContent = "…";
    drips24hEl.textContent = unique24hEl.textContent = amount24hEl.textContent = "…";
    latestEl.textContent = latestTimeEl.textContent = "…";
    statsNoteEl.textContent = "";
  }

  async function refreshStats() {
    try {
      setStatsLoading();
      const [all, day] = await Promise.all([
        fetchJSON("/api/stats"),
        fetchJSON("/api/stats?hours=24"),
      ]);

      dripsTotalEl.textContent = String(all.totalDrips ?? "0");
      uniqueTotalEl.textContent = String(all.uniqueRecipients ?? "0");
      amountTotalEl.textContent = (all.totalAmount ? (all.totalAmount + " tBNB") : "0 tBNB");

      drips24hEl.textContent = String(day.totalDrips ?? "0");
      unique24hEl.textContent = String(day.uniqueRecipients ?? "0");
      amount24hEl.textContent = (day.totalAmount ? (day.totalAmount + " tBNB") : "0 tBNB");

      latestEl.textContent = all.latestBlock ? `Block ${all.latestBlock}` : "—";
      latestTimeEl.textContent = all.latestTimestamp ? new Date(all.latestTimestamp * 1000).toLocaleString() : "";
    } catch (err) {
      dripsTotalEl.textContent = uniqueTotalEl.textContent = amountTotalEl.textContent = "—";
      drips24hEl.textContent = unique24hEl.textContent = amount24hEl.textContent = "—";
      latestEl.textContent = latestTimeEl.textContent = "—";
      statsNoteEl.textContent = "Stats unavailable";
      console.warn("Stats error:", err);
    }
  }

  btn.addEventListener("click", async () => {
    const to = document.getElementById("addr").value.trim();

    if (!isHexAddress(to)) {
      alert("Please enter a valid 0x address.");
      return;
    }

    btn.disabled = true;
    log("Requesting 0.3 tBNB for " + shortenAddress(to) + "…", "info", { icon: "⏳" });

    try {
      const url = "/api/drip?to=" + encodeURIComponent(to);
      const res = await fetch(url, { method: "POST" });

      const text = await res.text();
      let data;
      try { data = JSON.parse(text); } catch { data = { raw: text }; }

      if (!res.ok) {
        log("Error: " + (data.error || text), "error");
        alert("Error: " + (data.error || text));
      } else {
        const explorer = "https://testnet.bscscan.com/tx/" + data.hash;
        const html = `Sent <b>0.3 tBNB</b> to <code>${shortenAddress(to)}</code> — <a href="${explorer}" target="_blank" rel="noopener">View on BscScan</a>`;
        log(html, "success", { html: true });
        // Update usage stats after a successful drip
        refreshStats();
      }
    } catch (err) {
      console.error(err);
      log("Request failed: " + (err.message || err), "error");
      alert("Request failed: " + (err.message || err));
    } finally {
      btn.disabled = false;
    }
  });

  // Initial stats load + periodic refresh
  refreshStats();
  setInterval(refreshStats, 60_000);
</script>
</body>
</html>
